---
title: "PCIT-CoS-Waitlist RCT Paper 1: BITSEA Problem"
author: "Nancy Briggs"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 6
    toc_float: true
---


### BITSEA Problem {.tabset .tabset-fade .tabset-pills}

Output run on `r Sys.Date()`



Values have been calculated by:

- missing values are: 3, 888, 999, 9999
- sum computed from:  pf2, pf3, pf4, pf6, pf7, pf8, pf9, pf11, pf12, pf14, pf16, pf17, pf18, pf21, pf23, pf24, pf26, pf27, pf28, pf30, pf32, pf33, pf34, pf35, pf36, pf37, pf38, pf39, pf40, pf41, pf42



```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(warn=1)
library(lme4)

library(tidyverse)
library(tidyselect)
library(SASmarkdown)
library(nlme)
library(emmeans)
library(multcomp)
library(kableExtra)
library(ggplot2)
library(lmerTest)
library(effectsize)
library(boot)

options(warnPartialMatchAttr = FALSE, 
  warnPartialMatchDollar = FALSE,
  warnPartialMatchArgs = FALSE)

```


```{r, echo=FALSE}
# Data 
# Import data
# recoding for CBCL and totals done in SPSS before bringing data in to R

data <- read.csv("../data_prep.csv", fileEncoding="UTF-8-BOM")
names(data) <- tolower(names(data))

# keep relevant demographic and outcome variables

data <- data %>%
  dplyr::select(id:treatment_time_mins, dobchild, sexchild, numbhousehold, incfamily,
                #DPICS Labelled Praise
                parent_lp_perc_total_time_1, parent_lp_perc_total_time_2, parent_lp_perc_total_time_3,
                #DPICS Negative Talk
                parent_nta_perc_total_time_1, parent_nta_perc_total_time_2, parent_nta_perc_total_time_3,
                #BCAP
                prebcap_risk, post_bcap_risk, fu_bcap_risk,
                #BCAP Lie scale
                prebcap_lie, post_bcap_lie, fu_bcap_lie,
                
                # Child Ext Behav
                cbclext_pre_total,cbclext_post_total,cbclext_fu_total,

                # CBCL Internalising Behav
                cbclint_pre_total,cbclint_post_total,cbclint_fu_total,
                
                #Child Compliance
                total_co_perc_time_1,total_co_perc_time_2,total_co_perc_time_3,
                
                # others, but not essential for paper
                #3. Child Temperament (ECBQ)
                #4. Child social-emotional functioning - 
                #5. Child social-emotional functioning - #2: Child Devereux Early Childhood Assessment (DECA)
                
                #CQQ self Effic.
                pre_ccq_a_topse_mean, post_ccq_a_topse_mean ,fu_ccq_a_topse_mean, 

                # CCQ Caregiving Helplessness
                pre_chqd_sum, post_chqd_sum, fu_chqd_sum,
                
                # CCQ Hostil Parenting
                pre_ccqc_sum, post_ccqc_sum, fu_ccqc_sum,
                
                #1: Brief Infant Toddler Social Emotional Assessment (BITSEA)
                # Problem
                pre_bitseaprob_sum, post_bitseaprob_sum, fu_bitseaprob_sum,
                # Competence
                pre_bitseacomp_sum, post_bitseacomp_sum,fu_bitseacomp_sum

                )


```




#### Descriptives

```{r, echo=FALSE}
#   pre_bitseaprob_mean, post_bitseaprob_mean, fu_bitseaprob_mean,
desctable <- data %>%
  group_by(group) %>%

  summarise(n1 = sum(!is.na(pre_bitseaprob_sum)) , 
            mean1=mean(pre_bitseaprob_sum, na.rm = T ),
            sd1=sd(pre_bitseaprob_sum, na.rm = T ),
            median1=median(pre_bitseaprob_sum, na.rm = T ),
            min1=min(pre_bitseaprob_sum, na.rm = T ),
            max1=max(pre_bitseaprob_sum, na.rm = T ),
            
            n2 = sum(!is.na(post_bitseaprob_sum)) , 
            mean2=mean(post_bitseaprob_sum, na.rm = T ),
            sd2=sd(post_bitseaprob_sum, na.rm = T ),
            median2=median(post_bitseaprob_sum, na.rm = T ),
            min2=min(post_bitseaprob_sum, na.rm = T ),
            max2=max(post_bitseaprob_sum, na.rm = T ),
            
            n3 = sum(!is.na(fu_bitseaprob_sum)) , 
            mean3=mean(fu_bitseaprob_sum, na.rm = T ),
            sd3=sd(fu_bitseaprob_sum, na.rm = T ),
            median3=median(fu_bitseaprob_sum, na.rm = T ),
            min3=min(fu_bitseaprob_sum, na.rm = T ),
            max3=max(fu_bitseaprob_sum, na.rm = T )  ) %>%
  pivot_longer(cols = -group,  
                names_to = c('.value', 'time'), 
                    names_pattern = '(.*)(\\d+)')

write.csv(desctable,"desctable.csv", row.names = TRUE)

```

```{r, echo=FALSE}
desctable %>%
           kbl(digits=3) %>%
           kable_minimal()
```



```{r, echo=FALSE}
##   pre_bitseaprob_mean, post_bitseaprob_mean, fu_bitseaprob_mean,
# Histograms
# plot
p <- data %>%
  dplyr::select(id,group, pre_bitseaprob_sum, post_bitseaprob_sum, fu_bitseaprob_sum) %>%
  pivot_longer( cols = c("pre_bitseaprob_sum", "post_bitseaprob_sum", "fu_bitseaprob_sum"),  names_prefix = "bitseaprob_", 
                names_to="t", values_to="outcome") %>%
  mutate(time = ifelse(t == "pre_bitseaprob_sum",  1,
                ifelse(t == "post_bitseaprob_sum", 2, 3))) 
  

  
hist<-ggplot(p, aes(x=outcome) )+
  geom_histogram(alpha=0.6, binwidth = 2) +
  xlab("BITSEA Problem") +
  ylab("Frequency") +
  facet_wrap(group~time)

group.labs <- c("PCIT-T", "COS-P", "Waitlist")
names(group.labs) <- c("1", "2", "3")

# New facet label names for group variable
time.labs <- c("Pre", "Post","FollowUp")
names(time.labs) <- c("1", "2","3")
# Create the plot
hist + theme_minimal() +
  facet_grid(
  group ~ time, 
  labeller = labeller(group = group.labs, time = time.labs) )

```

#### Model & Results

A linear mixed model with random effect for individual and fixed effects of group, time and the interaction was run. Estimated marginal means were obtained, and contrasts specified to test Hypothesis 1 and Hypothesis 2.

```{r, echo=FALSE, warning=FALSE}
#  analysis
dat <- data %>%
  dplyr::select(id,group, pre_bitseaprob_sum, post_bitseaprob_sum, fu_bitseaprob_sum) %>%
  pivot_longer( cols = c("pre_bitseaprob_sum", "post_bitseaprob_sum", "fu_bitseaprob_sum"),  names_prefix = "bitseaprob_", 
                names_to="t", values_to="outcome") %>%
  mutate(time = ifelse(t == "pre_bitseaprob_sum",  1,
                ifelse(t == "post_bitseaprob_sum", 2, 3)))
  

dat$time<- as.factor(dat$time)
dat$group<- as.factor(dat$group)

result0<-lmer(outcome ~ (1 | id), dat)
result1<-lmer(outcome ~ group + (1 | id), dat)
result2<-lmer(outcome ~ group + time + (1 | id), dat)
result3<-lmer(outcome ~ group*time + (1 | id), dat)

```





```{r, echo=FALSE}
anovatab<-anova(result0,result1,result2,result3)

anovatab <-anovatab %>%
           mutate(Effect = ifelse(npar == 3, "Intercept",
                           ifelse(npar == 5, "Group",
                           ifelse(npar == 7, "Time",
                           ifelse(npar == 10, "Group*Time",""))))) %>%
           relocate(Effect) 
anovatab %>%
           kbl(digits=3) %>%
           kable_styling()


## Extract pvaue for evidence / no evidence
evidence = ifelse(anovatab[4,9]<0.05, "evidence", "no evidence")
```



This is the ANOVA table for the model. p-values are likelihood ratio tests for adding the new term to the model just before. A p-value <0.05 indicates that adding that term results in better model fit. The most important p-value is the interaction p-value. Here, there is `r evidence` that the pattern of change over time is different among the groups (p=`r round(anovatab[4,9],3)`).




```{r}
summary(result3)
```



#### Estimated Means & Change

Estimated means for each Treatment and Time are presented. In addition, within-group
change between time points is presented with 95% CIs.


```{r child='bootstrapped_es_CI.Rmd'}
```

```{r child='TestingHypotheses.Rmd'}
```



#### Residuals

Assumptions of the model are met.

```{r, echo=FALSE, warning=FALSE}
plot(result3,form = resid(., type = "pearson") ~ predict(., re.form = NA) )


qqnorm(residuals(result3))
qqline(residuals(result3), col="red")

# plot residuals against predictors
dat <- na.omit(dat)
ggplot(data.frame(x1=dat$group,pearson=residuals(result3,type="pearson")),
       aes(x=x1,y=pearson)) +
  geom_point() +
  theme_bw()

ggplot(data.frame(x2=dat$time,pearson=residuals(result3,type="pearson")),
       aes(x=x2,y=pearson)) +
  geom_point() +
  theme_bw()


```

```{r}
rm(list = ls())
```